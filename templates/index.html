<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Canard Laqué | AI Receptionist</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom fonts */
        @font-face {
            font-family: 'SaintRegus';
            src: url('/static/SaintRegus-SemiBold.otf') format('opentype');
            font-weight: 600;
            font-style: normal;
        }

        @font-face {
            font-family: 'SaintRegusCondensed';
            src: url('/static/SaintRegus-SemiBoldCondensed.otf') format('opentype');
            font-weight: 600;
            font-style: normal;
        }

        :root {
            --lacquer-red: #A81C1C;
            --cream: #F2E9E4;
            --ink: #0A0A0A;
        }

        body {
            background-color: var(--ink);
            color: var(--cream);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            cursor: none;
        }

        .serif {
            font-family: 'SaintRegus', serif;
        }

        .serif-condensed {
            font-family: 'SaintRegusCondensed', serif;
        }

        #cursor {
            width: 20px;
            height: 20px;
            background: var(--lacquer-red);
            border-radius: 50%;
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: exclusion;
            transition: width 0.2s ease, height 0.2s ease, background-color 0.2s;
        }

        .glass-panel {
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            opacity: 0;
            transform: translateY(20px);
        }

        .reveal-text {
            clip-path: polygon(0 100%, 100% 100%, 100% 100%, 0% 100%);
            transform: translateY(100%);
            opacity: 0;
            display: inline-block;
        }

        .img-mask {
            clip-path: inset(100% 0 0 0);
        }

        .voice-bar {
            width: 6px;
            background: var(--lacquer-red);
            animation: sound 0ms -800ms linear infinite alternate;
            border-radius: 4px;
        }

        @keyframes sound {
            0% {
                height: 10px;
                opacity: 0.35;
            }

            100% {
                height: 60px;
                opacity: 1;
            }
        }

        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid rgba(168, 28, 28, 0.5);
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(168, 28, 28, 0.2);
            border-top-color: #A81C1C;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Loading dots */
        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #A81C1C;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        @media (max-height: 700px) {
            body {
                overflow-y: auto;
                height: auto;
            }
        }
    </style>
</head>

<body class="h-screen w-full relative antialiased selection:bg-red-900 selection:text-white overflow-hidden">

    <div id="cursor"></div>

    <nav class="absolute top-0 left-0 w-full p-6 md:p-8 flex justify-between items-center z-50 mix-blend-difference pointer-events-none">
        <div class="pointer-events-auto cursor-none">
            <div class="text-xl md:text-2xl font-semibold tracking-[0.15em] uppercase reveal-text nav-item serif-condensed">
                Le Canard Laqué
            </div>
        </div>

        <div class="pointer-events-auto cursor-none reveal-text nav-item">
            <a href="/static/menu.pdf" target="_blank" 
               class="border border-white/30 px-6 py-2 rounded-full text-sm uppercase tracking-widest hover:bg-white hover:text-black transition-colors duration-300">
               Voir le Menu
            </a>
        </div>
    </nav>

    <div class="fixed inset-0 z-0">
        <img src="/static/restaurant_image.webp"
            class="w-full h-full object-cover img-mask scale-110"
            id="hero-image" alt="Restaurant ambiance">
        <div id="hero-gradient" class="absolute inset-0 bg-black opacity-0"></div>
    </div>

    <!-- Centered Title -->
    <div class="fixed inset-0 z-10 flex items-start justify-center pointer-events-none pt-32 md:pt-40">
        <div class="text-center px-6">
            <h1 id="main-heading" class="text-6xl md:text-9xl font-bold leading-[0.9] serif tracking-tighter">
                Talk to<br><span class="text-[#D62828]">Our Concierge</span>
            </h1>
        </div>
    </div>

    <!-- Floating Interface Card -->
    <div class="fixed inset-0 z-20 flex items-end justify-center p-6 pb-20 md:pb-24 pointer-events-none">
        <div class="glass-panel rounded-2xl p-10 md:p-16 w-full max-w-2xl pointer-events-auto relative">

        <!-- STEP 1: CALL BUTTON -->
        <div id="step-call"
            class="relative z-10 flex flex-col items-center justify-center w-full reveal-form opacity-0 transform translate-y-10 transition-all duration-500">
            <div class="relative w-32 h-32 mb-8 group cursor-none">
                <div class="pulse-ring"></div>
                <div class="pulse-ring" style="animation-delay: 0.5s;"></div>
                <button id="startBtn"
                    class="absolute inset-0 bg-[#A81C1C] rounded-full flex items-center justify-center hover:bg-[#c42525] transition-colors shadow-[0_0_30px_rgba(168,28,28,0.6)] z-20 group-hover:scale-105 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-10 h-10 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                    </svg>
                </button>
            </div>
            <p class="text-sm uppercase tracking-[0.3em] text-gray-300 font-semibold">Hungry? Let's chat</p>
        </div>

        <!-- STEP 2: ACTIVE RECORDING -->
        <div id="step-active" class="hidden relative z-10 flex flex-col items-center justify-center w-full h-full">
            <div class="mb-10 text-center space-y-2">
                <div class="text-[#A81C1C] text-xs font-bold tracking-widest uppercase animate-pulse">● Recording</div>
                <h3 class="text-2xl serif italic text-white" id="status-text">I'm listening...</h3>
            </div>

            <!-- Visualizer -->
            <div class="h-24 flex items-center justify-center gap-1.5 mb-12">
                <div class="voice-bar" style="animation-duration: 474ms;"></div>
                <div class="voice-bar" style="animation-duration: 433ms;"></div>
                <div class="voice-bar" style="animation-duration: 407ms;"></div>
                <div class="voice-bar" style="animation-duration: 458ms;"></div>
                <div class="voice-bar" style="animation-duration: 400ms;"></div>
                <div class="voice-bar" style="animation-duration: 427ms;"></div>
                <div class="voice-bar" style="animation-duration: 443ms;"></div>
                <div class="voice-bar" style="animation-duration: 470ms;"></div>
                <div class="voice-bar" style="animation-duration: 420ms;"></div>
            </div>

            <!-- Loading indicator -->
            <div id="loading-indicator" class="hidden flex flex-col items-center gap-4 mb-8">
                <div class="loading-spinner"></div>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <button id="endBtn"
                class="px-8 py-3 border border-white/20 rounded-full text-xs uppercase tracking-widest hover:bg-white hover:text-black transition-colors cursor-none">
                End conversation
            </button>
        </div>

        <!-- STEP 3: BOOKING CONFIRMATION -->
        <div id="step-confirm" class="hidden relative z-10 w-full">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <h3 class="text-xl serif italic mb-1">Booking Confirmed</h3>
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Your reservation</p>
                </div>
                <div
                    class="w-8 h-8 rounded-full bg-green-500/20 text-green-500 flex items-center justify-center text-xs">
                    ✓</div>
            </div>

            <div id="booking-details" class="space-y-4 font-mono text-sm mb-8">
                <div class="flex justify-between border-b border-white/10 pb-2">
                    <span class="text-gray-500">Name</span>
                    <span id="confirm-name">-</span>
                </div>
                <div class="flex justify-between border-b border-white/10 pb-2">
                    <span class="text-gray-500">Date</span>
                    <span id="confirm-date">-</span>
                </div>
                <div class="flex justify-between border-b border-white/10 pb-2">
                    <span class="text-gray-500">Time</span>
                    <span id="confirm-time">-</span>
                </div>
                <div class="flex justify-between border-b border-white/10 pb-2">
                    <span class="text-gray-500">Guests</span>
                    <span id="confirm-guests">-</span>
                </div>
            </div>

            <button id="resetBtn"
                class="w-full bg-[#A81C1C] py-3 rounded text-xs uppercase font-bold tracking-wider hover:bg-[#8a1515] transition-colors cursor-none">
                New Reservation
            </button>
        </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/split-type"></script>

    <script>
        // Split text into lines using SplitType
        const heading = new SplitType('#main-heading', { types: 'lines' });
        
        // Wrap each line for masking
        heading.lines.forEach(line => {
            // Create wrapper div for overflow hidden
            const wrapper = document.createElement('div');
            wrapper.style.overflow = 'hidden';
            line.parentNode.insertBefore(wrapper, line);
            wrapper.appendChild(line);
            
            // Wrap text content in span for animation
            const span = document.createElement('span');
            span.innerHTML = line.innerHTML;
            span.style.display = 'inline-block';
            span.style.transform = 'translateY(100%)';
            line.innerHTML = '';
            line.appendChild(span);
        });

        // Animation setup
        const tl = gsap.timeline({ defaults: { ease: "power3.inOut" } });
        tl.to("#hero-image", { clipPath: "inset(0% 0 0 0)", duration: 1.8, scale: 1, ease: "power2.out" })
            .to("#hero-gradient", { opacity: 0.5, duration: 1.2, ease: "power2.inOut" }, "-=0.8")
            .to("#main-heading .line span", { 
                y: 0, 
                duration: 1.5, 
                ease: "power4.out", 
                stagger: 0.1 
            }, "-=1")
            .to([".nav-item"], { y: 0, opacity: 1, clipPath: "polygon(0 0, 100% 0, 100% 100%, 0% 100%)", stagger: 0.05, duration: 0.8 }, "-=0.8")
            .to(".glass-panel, .reveal-form", { opacity: 1, y: 0, duration: 1, ease: "back.out(1.7)" }, "-=1.0");

        // Cursor
        const cursor = document.getElementById('cursor');
        let mouseX = 0, mouseY = 0, cursorX = 0, cursorY = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        gsap.ticker.add(() => {
            const speed = 0.5;
            const dt = 1.0 - Math.pow(1.0 - speed, gsap.ticker.deltaRatio());
            cursorX += (mouseX - cursorX) * dt;
            cursorY += (mouseY - cursorY) * dt;
            cursor.style.transform = `translate(${cursorX - 10}px, ${cursorY - 10}px)`;
        });

        const hoverables = document.querySelectorAll('button, a, .nav-item');
        hoverables.forEach(el => {
            el.addEventListener('mouseenter', () => {
                gsap.to(cursor, { width: 60, height: 60, backgroundColor: "transparent", border: "2px solid #A81C1C", mixBlendMode: "normal", duration: 0.2 });
            });
            el.addEventListener('mouseleave', () => {
                gsap.to(cursor, { width: 20, height: 20, backgroundColor: "#A81C1C", border: "none", mixBlendMode: "exclusion", duration: 0.2 });
            });
        });

        // AI Logic
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentAudio = null;
        let mediaStream = null;

        document.getElementById('startBtn').addEventListener('click', startConversation);
        document.getElementById('endBtn').addEventListener('click', endConversation);
        document.getElementById('resetBtn').addEventListener('click', resetFlow);

        function endConversation() {
            // Stop recording if active
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
            }
            // Stop any playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            // Stop media stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            isRecording = false;
            // Reset backend and return to start
            fetch('/api/reset', { method: 'POST' });
            resetFlow();
        }

        async function startConversation() {
            // Reset backend
            await fetch('/api/reset', { method: 'POST' });

            // UI transition
            gsap.to("#step-call", {
                opacity: 0, y: -20, duration: 0.5,
                onComplete: () => {
                    document.getElementById('step-call').classList.add('hidden');
                    const stepActive = document.getElementById('step-active');
                    stepActive.classList.remove('hidden');
                    gsap.fromTo(stepActive, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.6 });
                    startRecording();
                }
            });
        }

        // Voice Activity Detection settings
        const SILENCE_THRESHOLD = 0.025;  // Threshold for silence detection
        const SPEECH_THRESHOLD = 0.035;   // Level that indicates actual speech
        const SILENCE_DURATION = 300;     // Stop 300ms after speech ends (was 500)
        const MIN_RECORDING_TIME = 400;   // Minimum recording time (was 800)
        const MAX_RECORDING_TIME = 15000; // Maximum recording time (ms)
        
        let audioContext;
        let analyser;
        let silenceStart = null;
        let recordingStartTime = null;
        let hasDetectedSpeech = false;    // Track if user actually spoke

        async function startRecording() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(mediaStream);
                audioChunks = [];

                // Set up audio analysis for VAD
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(mediaStream);
                source.connect(analyser);
                analyser.fftSize = 512;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    isRecording = false;
                    // Clean up audio context
                    if (audioContext) {
                        audioContext.close();
                        audioContext = null;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudio(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                silenceStart = null;
                hasDetectedSpeech = false;
                document.getElementById('status-text').innerText = "I'm listening...";

                // Voice Activity Detection loop
                function checkAudioLevel() {
                    if (!isRecording || mediaRecorder.state !== 'recording') return;
                    
                    analyser.getByteTimeDomainData(dataArray);
                    
                    // Calculate audio level (RMS)
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        const value = (dataArray[i] - 128) / 128;
                        sum += value * value;
                    }
                    const rms = Math.sqrt(sum / bufferLength);
                    
                    const elapsed = Date.now() - recordingStartTime;
                    
                    // Detect if user is speaking
                    if (rms > SPEECH_THRESHOLD) {
                        hasDetectedSpeech = true;
                        silenceStart = null;  // Reset silence timer while speaking
                    }
                    // Only check for silence AFTER user has spoken
                    else if (hasDetectedSpeech && rms < SILENCE_THRESHOLD) {
                        if (silenceStart === null) {
                            silenceStart = Date.now();
                        } else if (Date.now() - silenceStart > SILENCE_DURATION) {
                            // User spoke and has been silent - stop recording
                            mediaRecorder.stop();
                            return;
                        }
                    }
                    
                    // Max recording time safety
                    if (elapsed > MAX_RECORDING_TIME) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    // Fallback: if no speech detected after 5 seconds, stop
                    if (!hasDetectedSpeech && elapsed > 5000) {
                        mediaRecorder.stop();
                        return;
                    }
                    
                    // Continue checking
                    requestAnimationFrame(checkAudioLevel);
                }
                
                // Start VAD loop
                checkAudioLevel();

            } catch (err) {
                alert('Microphone access denied: ' + err.message);
            }
        }

        async function processAudio(audioBlob) {
            document.getElementById('status-text').innerText = "Processing...";
            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                // 1. Transcribe
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');

                const transcribeRes = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const transcribeData = await transcribeRes.json();
                const transcription = transcribeData.transcription;

                // Check for goodbye/end phrases
                const lowerTranscript = transcription.toLowerCase();
                if (lowerTranscript.includes('goodbye') || lowerTranscript.includes('bye') || lowerTranscript.includes('end')) {
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('status-text').innerText = "Goodbye!";
                    setTimeout(resetFlow, 1500);
                    return;
                }

                // 2. Get LLM response
                const chatRes = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: transcription })
                });
                const chatData = await chatRes.json();
                const response = chatData.response;
                const booking = chatData.booking;

                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('status-text').innerText = "Speaking...";

                // 3. TTS
                const ttsRes = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: response })
                });
                const audioBlob2 = await ttsRes.blob();
                const audioUrl = URL.createObjectURL(audioBlob2);
                currentAudio = new Audio(audioUrl);
                
                // Start next recording as soon as audio ends
                currentAudio.onended = () => {
                    if (booking.ready) {
                        showConfirmation(booking);
                    } else {
                        document.getElementById('status-text').innerText = "I'm listening...";
                        startRecording();
                    }
                };
                
                currentAudio.play();

            } catch (error) {
                console.error('Processing error:', error);
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('status-text').innerText = "Error. Try again.";
                setTimeout(() => {
                    document.getElementById('status-text').innerText = "I'm listening...";
                    startRecording();
                }, 1500);
            }
        }

function showConfirmation(booking) {
            console.log("CONFIRMATION RECEIVED:", booking); // DEBUG

            gsap.to("#step-active", {
                opacity: 0, scale: 1.05, duration: 0.4,
                onComplete: () => {
                    document.getElementById('step-active').classList.add('hidden');

                    const detailsContainer = document.getElementById('booking-details');
                    const titleElement = document.querySelector('#step-confirm h3');
                    const subtitleElement = document.querySelector('#step-confirm p');
                    let htmlContent = '';

                    // On normalise le type (en minuscules pour éviter les erreurs)
                    const bookingType = (booking.type || '').toLowerCase();
                    console.log("DETECTED TYPE:", bookingType); // DEBUG

                    // 1. Ligne NOM (Toujours là)
                    htmlContent += `
                        <div class="flex justify-between border-b border-white/10 pb-2">
                            <span class="text-gray-500">Name</span>
                            <span class="font-medium text-white">${booking.name || '-'}</span>
                        </div>`;

                    // 2. Condition stricte
                    if (bookingType === 'takeout') {
                        // --- TAKEOUT ---
                        titleElement.innerText = "Order Confirmed";
                        subtitleElement.innerText = "Takeout Details";
                        
                        htmlContent += `
                            <div class="flex justify-between border-b border-white/10 pb-2 mt-4">
                                <span class="text-gray-500">Pickup Time</span>
                                <span class="font-medium text-white">${booking.time || '-'}</span>
                            </div>
                            <div class="flex justify-between border-b border-white/10 pb-2 mt-4">
                                <span class="text-gray-500">Items</span>
                                <span class="font-medium text-white text-right w-2/3 leading-tight">${booking.items || '-'}</span>
                            </div>`;
                    } else {
                        // --- BOOKING (Défaut) ---
                        titleElement.innerText = "Booking Confirmed";
                        subtitleElement.innerText = "Table Reservation";

                        htmlContent += `
                            <div class="flex justify-between border-b border-white/10 pb-2 mt-4">
                                <span class="text-gray-500">Date</span>
                                <span class="font-medium text-white">${booking.date || '-'}</span>
                            </div>
                            <div class="flex justify-between border-b border-white/10 pb-2 mt-4">
                                <span class="text-gray-500">Time</span>
                                <span class="font-medium text-white">${booking.time || '-'}</span>
                            </div>
                            <div class="flex justify-between border-b border-white/10 pb-2 mt-4">
                                <span class="text-gray-500">Guests</span>
                                <span class="font-medium text-white">${booking.guests || '-'}</span>
                            </div>`;
                    }

                    detailsContainer.innerHTML = htmlContent;

                    const stepConfirm = document.getElementById('step-confirm');
                    stepConfirm.classList.remove('hidden');
                    gsap.fromTo(stepConfirm, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.6, ease: "back.out(1.2)" });
                }
            });
        }

        function resetFlow() {
            gsap.to("#step-confirm, #step-active", {
                opacity: 0, y: 20, duration: 0.4,
                onComplete: () => {
                    document.getElementById('step-confirm').classList.add('hidden');
                    document.getElementById('step-active').classList.add('hidden');
                    const stepCall = document.getElementById('step-call');
                    stepCall.classList.remove('hidden');
                    gsap.fromTo(stepCall, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.5 });

                    document.getElementById('status-text').innerText = "I'm listening...";
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            });
        }

    </script>
</body>

</html>